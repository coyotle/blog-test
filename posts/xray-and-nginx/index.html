<!doctype html><html lang=ru dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Xray с XTLS-Reality и Nginx на одном порту | Мини-блог об IT, Linux, Open Source, Tech</title><meta name=keywords content="linux,network,vpn"><meta name=description content="Что делаем? Настроим так чтобы на одном порту 443 висел и nginx с нашими сайтами и xray XTLS-Reality, который работает как прокси для авторизованных пользователей и притворяется валидным сайтом (в примере www.google.com) для всех остальных.
XTLS-Reality предназначен для защиты от выявления методом active probing. В отличие от старых протоколов (Shadowsocks, VMess, VLESS, и транспорта XTLS-Vision), определение “свой/чужой” здесь происходит на этапе TLS-хендшейка в момент чтения ClientHello. Если клиент опознан как “свой”, сервер работает как прокси, а если нет - TLS подключение передается на другой хост с TLS (например, google.com), и таким образом клиент (или цензор, желающий методом active probing проверить, что прячется на том конце) получит настоящий TLS-сертификат от google.com и настоящие данные с этого сервера."><meta name=author content><link rel=canonical href=https://coyotle.ru/posts/xray-and-nginx/><link crossorigin=anonymous href=/assets/css/stylesheet.d6626ca70f3a7dda16dfce9eb29df152c81185d6739a741054093fb92b9e6839.css integrity="sha256-1mJspw86fdoW386esp3xUsgRhdZzmnQQVAk/uSueaDk=" rel="preload stylesheet" as=style><link rel=icon href=https://coyotle.ru/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://coyotle.ru/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://coyotle.ru/favicon-32x32.png><link rel=apple-touch-icon href=https://coyotle.ru/apple-touch-icon.png><link rel=mask-icon href=https://coyotle.ru/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ru href=https://coyotle.ru/posts/xray-and-nginx/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://coyotle.ru/posts/xray-and-nginx/"><meta property="og:site_name" content="Мини-блог об IT, Linux, Open Source, Tech"><meta property="og:title" content="Xray с XTLS-Reality и Nginx на одном порту"><meta property="og:description" content="Что делаем? Настроим так чтобы на одном порту 443 висел и nginx с нашими сайтами и xray XTLS-Reality, который работает как прокси для авторизованных пользователей и притворяется валидным сайтом (в примере www.google.com) для всех остальных.
XTLS-Reality предназначен для защиты от выявления методом active probing. В отличие от старых протоколов (Shadowsocks, VMess, VLESS, и транспорта XTLS-Vision), определение “свой/чужой” здесь происходит на этапе TLS-хендшейка в момент чтения ClientHello. Если клиент опознан как “свой”, сервер работает как прокси, а если нет - TLS подключение передается на другой хост с TLS (например, google.com), и таким образом клиент (или цензор, желающий методом active probing проверить, что прячется на том конце) получит настоящий TLS-сертификат от google.com и настоящие данные с этого сервера."><meta property="og:locale" content="ru-RU"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-13T18:12:04+03:00"><meta property="article:modified_time" content="2023-08-13T18:12:04+03:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Network"><meta property="article:tag" content="Vpn"><meta name=twitter:card content="summary"><meta name=twitter:title content="Xray с XTLS-Reality и Nginx на одном порту"><meta name=twitter:description content="Что делаем? Настроим так чтобы на одном порту 443 висел и nginx с нашими сайтами и xray XTLS-Reality, который работает как прокси для авторизованных пользователей и притворяется валидным сайтом (в примере www.google.com) для всех остальных.
XTLS-Reality предназначен для защиты от выявления методом active probing. В отличие от старых протоколов (Shadowsocks, VMess, VLESS, и транспорта XTLS-Vision), определение “свой/чужой” здесь происходит на этапе TLS-хендшейка в момент чтения ClientHello. Если клиент опознан как “свой”, сервер работает как прокси, а если нет - TLS подключение передается на другой хост с TLS (например, google.com), и таким образом клиент (или цензор, желающий методом active probing проверить, что прячется на том конце) получит настоящий TLS-сертификат от google.com и настоящие данные с этого сервера."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Посты","item":"https://coyotle.ru/posts/"},{"@type":"ListItem","position":2,"name":"Xray с XTLS-Reality и Nginx на одном порту","item":"https://coyotle.ru/posts/xray-and-nginx/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Xray с XTLS-Reality и Nginx на одном порту","name":"Xray с XTLS-Reality и Nginx на одном порту","description":"Что делаем? Настроим так чтобы на одном порту 443 висел и nginx с нашими сайтами и xray XTLS-Reality, который работает как прокси для авторизованных пользователей и притворяется валидным сайтом (в примере www.google.com) для всех остальных.\nXTLS-Reality предназначен для защиты от выявления методом active probing. В отличие от старых протоколов (Shadowsocks, VMess, VLESS, и транспорта XTLS-Vision), определение “свой/чужой” здесь происходит на этапе TLS-хендшейка в момент чтения ClientHello. Если клиент опознан как “свой”, сервер работает как прокси, а если нет - TLS подключение передается на другой хост с TLS (например, google.com), и таким образом клиент (или цензор, желающий методом active probing проверить, что прячется на том конце) получит настоящий TLS-сертификат от google.com и настоящие данные с этого сервера.\n","keywords":["linux","network","vpn"],"articleBody":"Что делаем? Настроим так чтобы на одном порту 443 висел и nginx с нашими сайтами и xray XTLS-Reality, который работает как прокси для авторизованных пользователей и притворяется валидным сайтом (в примере www.google.com) для всех остальных.\nXTLS-Reality предназначен для защиты от выявления методом active probing. В отличие от старых протоколов (Shadowsocks, VMess, VLESS, и транспорта XTLS-Vision), определение “свой/чужой” здесь происходит на этапе TLS-хендшейка в момент чтения ClientHello. Если клиент опознан как “свой”, сервер работает как прокси, а если нет - TLS подключение передается на другой хост с TLS (например, google.com), и таким образом клиент (или цензор, желающий методом active probing проверить, что прячется на том конце) получит настоящий TLS-сертификат от google.com и настоящие данные с этого сервера.\nНастройка Nginx Nginx по sni будет определять имя сайта:\nесли сайт из нашего домена - обработаем его как обычно если сайт не наш - перенаправим запрос в xray. Имеет смысл спрятать *.example.ru за Сloudflare чтобы не обращаться к вашему домену по IP за которым якобы работает www.google.com, это может быть подозрительно.\nДолжен быть установлен модуль stream для nginx. Как это сделать смотрите инструкции для ваше дистрибутива.\nВ /etc/nginx/nginx.conf добавляем:\nstream { include /etc/nginx/stream-enabled/*.conf; } Создаем /etc/nginx/stream-enabled/proxy.conf\nmap $ssl_preread_server_name $sni_name { hostnames; www.google.com xray; example.ru www; *.example.ru www; default xray; } upstream xray { server 127.0.0.1:8443; } upstream www { server 127.0.0.1:7443; } server { listen 443; proxy_pass $sni_name; ssl_preread on; } Для ваших сайтов в настройках Nginx поменяйте порт с 443 на 7443.\nНастройка Xray сервера Скачиваем и распаковываем бинарник для Linux:\nwget -c https://github.com/XTLS/Xray-core/releases/download/v1.8.3/Xray-linux-64.zip unzip Xray-linux-64.zip -d /opt/xray Последние релизы см тут https://github.com/XTLS/Xray-core/releases/\nСоздаем /etc/systemd/system/xray.service:\n[Unit] Description=Xray Service Documentation=https://github.com/xtls After=network.target nss-lookup.target [Service] User=nobody CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE NoNewPrivileges=true ExecStart=/opt/xray/xray run -config /opt/xray/config.json Restart=on-failure RestartPreventExitStatus=23 LimitNPROC=10000 LimitNOFILE=1000000 [Install] WantedBy=multi-user.target Включаем сервис:\nsystemctl enable xray Создаем ключи\n# ID клиента /opt/xray/xray uuid UUID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx # приватный и публичные ключи сервера /opt/xray/xray x25519 Private key: YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY Public key: ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ # short ID openssl rand -hex 8 aaaaaaabbbbbbb /opt/xray/config.json { \"log\": { \"loglevel\": \"warning\" // info для отладки }, \"routing\": { \"rules\": [], \"domainStrategy\": \"AsIs\" }, \"inbounds\": [ { \"listen\": \"0.0.0.0\", \"port\": 8443, \"protocol\": \"vless\", \"tag\": \"vless_tls\", \"settings\": { \"clients\": [ { \"id\": \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\", // ID клиента \"email\": \"user1@myserver\", \"flow\": \"xtls-rprx-vision\" } ], \"decryption\": \"none\" }, \"streamSettings\": { \"network\": \"tcp\", \"security\": \"reality\", \"realitySettings\": { \"show\": false, \"dest\": \"www.google.com:443\", \"xver\": 0, \"serverNames\": [\"www.google.com\"], \"privateKey\": \"YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY\", // приватный ключ сервер \"minClientVer\": \"\", \"maxClientVer\": \"\", \"maxTimeDiff\": 0, \"shortIds\": [\"aaaaaaabbbbbbb\"] // short ID } }, \"sniffing\": { \"enabled\": true, \"destOverride\": [\"http\", \"tls\", \"quic\"] } } ], \"outbounds\": [ { \"protocol\": \"freedom\", \"tag\": \"direct\" }, { \"protocol\": \"blackhole\", \"tag\": \"block\" } ] } systemctl start xray Настройка XRay клиента Так же скачиваем и распаковываем клиент. Настраиваем config.json:\n{ \"log\": { \"loglevel\": \"warning\" }, \"inbounds\": [ { \"listen\": \"127.0.0.1\", \"port\": \"1080\", \"protocol\": \"socks\", \"sniffing\": { \"enabled\": true, \"destOverride\": [\"http\", \"tls\"], \"routeOnly\": false }, \"settings\": { \"auth\": \"noauth\", \"udp\": true } }, { \"listen\": \"127.0.0.1\", \"port\": \"1081\", \"protocol\": \"http\" } ], \"outbounds\": [ { \"protocol\": \"vless\", \"settings\": { \"vnext\": [ { \"address\": \"123.44.55.67\", //адрес сервера \"port\": 443, \"users\": [ { \"id\": \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\", \"email\": \"user1@myserver\", \"flow\": \"xtls-rprx-vision\", \"encryption\": \"none\" } ] } ] }, \"streamSettings\": { \"network\": \"tcp\", \"security\": \"reality\", \"realitySettings\": { \"serverName\": \"www.google.com\", \"publicKey\": \"ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ\", \"shortId\": \"aaaaaaabbbbbbb\", \"fingerprint\": \"chrome\" } }, \"tag\": \"proxy\" }, { \"protocol\": \"freedom\", \"tag\": \"direct\" } ], \"routing\": { \"domainStrategy\": \"AsIs\", \"rules\": [ { \"type\": \"field\", \"ip\": [\"geoip:private\"], \"outboundTag\": \"direct\" } ] } } ./xray run -c ./config.json После запуска xray на клиенте будет доступен socks прокси на порту 1080 и http на 1081.\nДля проверки на локальной машине можете добавить в /etc/hosts:\n123.44.55.67 www.google.com Если все ОК и попытаться открыть www.google.com в браузере - вы должны через xray получить рабочий сайт google. Это то, что так же должен увидеть человек, который делает active probing вашего хоста.\nСсылки для автоматической настройки клиентов Для быстрой настойки например мобильных клиентов можно подговорить ссылку со всеми параметрами подключения и импортировать её в клиенте.\nСсылка должна быть вида vless://xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx@123.44.55.67:443?security=reality\u0026encryption=none\u0026pbk=ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ\u0026headerType=none\u0026fp=chrome\u0026type=tcp\u0026flow=xtls-rprx-vision\u0026sni=www.google.com\u0026sid=aaaaaaabbbbbbb#vless\nСсылку можно конвертировать в QR и передавать другим пользователям.\n[UPD] Дополнение от @Ysery Возникла проблема — в логах при обращении к сайту(ам) IP адреса посетителей определяются как 127.0.0.1.\nНашёл решение, используя proxy_protocol. Вот как это выглядит в конфиге:\n... upstream xray { server 127.0.0.1:8050; } upstream www { server 127.0.0.1:7443; } server { listen 443; proxy_pass $sni_name; proxy_protocol on; ssl_preread on; } server { listen 8050 proxy_protocol; proxy_pass 127.0.0.1:8443; } Не забудьте также в блоке слушателей сайта указать\nlisten 7443 ssl proxy_protocol; listen [::]:7443 ssl proxy_protocol; И в блоке http вот это надо прописать.\nhttp { # Включаем поддержку реального IP set_real_ip_from 127.0.0.1; #Доверяем локальному прокси real_ip_header proxy_protocol; #Используем заголовок для получения реального IP клиента (чтобы в логах именно он и прописывался) ... Принцип прост: в просушиваемый на 443 порту TCP трафик добавляется заголовок с IP адресом при передаче слушателю на сервере. А чтобы отключить такое поведение для трафика, что передаётся на xray, он проходит через ещё один сервер, где заголовки эти удаляются.\nУточню на всякий случай, что указывать надо поддержку proxy_protocol только для соответствующего слушающего порта (блок слушателей сайта). Для остальных это делать не надо, включая quic, который работает на 443 порту, но по UDP и, соответственно, никак не мешает слушателю в блоке stream, который оперирует только TCP.\n","wordCount":"864","inLanguage":"ru","datePublished":"2023-08-13T18:12:04+03:00","dateModified":"2023-08-13T18:12:04+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://coyotle.ru/posts/xray-and-nginx/"},"publisher":{"@type":"Organization","name":"Мини-блог об IT, Linux, Open Source, Tech","logo":{"@type":"ImageObject","url":"https://coyotle.ru/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://coyotle.ru/ accesskey=h title="Мини-блог об IT, Linux, Open Source, Tech (Alt + H)">Мини-блог об IT, Linux, Open Source, Tech</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://coyotle.ru/tags/ title=тэги><span>тэги</span></a></li><li><a href=https://coyotle.ru/about/ title="обо мне"><span>обо мне</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Xray с XTLS-Reality и Nginx на одном порту</h1><div class=post-meta><span title='2023-08-13 18:12:04 +0300 +0300'>13 августа 2023</span></div></header><div class=post-content><p>Что делаем? Настроим так чтобы на одном порту <code>443</code> висел и nginx с нашими сайтами и xray XTLS-Reality, который работает как прокси для авторизованных пользователей и притворяется валидным сайтом (в примере <a href=https://www.google.com>www.google.com</a>) для всех остальных.</p><p>XTLS-Reality предназначен для защиты от выявления методом active probing. В отличие от старых протоколов (Shadowsocks, VMess, VLESS, и транспорта XTLS-Vision), определение “свой/чужой” здесь происходит на этапе TLS-хендшейка в момент чтения ClientHello. Если клиент опознан как “свой”, сервер работает как прокси, а если нет - TLS подключение передается на другой хост с TLS (например, google.com), и таким образом клиент (или цензор, желающий методом active probing проверить, что прячется на том конце) получит настоящий TLS-сертификат от google.com и настоящие данные с этого сервера.</p><h3 id=настройка-nginx>Настройка Nginx<a hidden class=anchor aria-hidden=true href=#настройка-nginx>#</a></h3><p>Nginx по sni будет определять имя сайта:</p><ul><li>если сайт из нашего домена - обработаем его как обычно</li><li>если сайт не наш - перенаправим запрос в xray.</li></ul><blockquote><p>Имеет смысл спрятать <code>*.example.ru</code> за Сloudflare чтобы не обращаться к вашему домену по IP за которым якобы работает <a href=https://www.google.com>www.google.com</a>, это может быть подозрительно.</p></blockquote><blockquote><p>Должен быть установлен модуль stream для nginx. Как это сделать смотрите инструкции для ваше дистрибутива.</p></blockquote><p>В <code>/etc/nginx/nginx.conf</code> добавляем:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>stream</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>include</span> <span class=s>/etc/nginx/stream-enabled/*.conf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Создаем <code>/etc/nginx/stream-enabled/proxy.conf</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>map</span> <span class=nv>$ssl_preread_server_name</span> <span class=nv>$sni_name</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>hostnames</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>www.google.com</span>      <span class=s>xray</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>example.ru</span>           <span class=s>www</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>*.example.ru</span>         <span class=s>www</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>default</span>              <span class=s>xray</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>upstream</span> <span class=s>xray</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>server</span> <span class=n>127.0.0.1</span><span class=p>:</span><span class=mi>8443</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>upstream</span> <span class=s>www</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>server</span> <span class=n>127.0.0.1</span><span class=p>:</span><span class=mi>7443</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span>          <span class=mi>443</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span>      <span class=nv>$sni_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_preread</span>     <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Для ваших сайтов в настройках Nginx поменяйте порт с <code>443</code> на <code>7443</code>.</p><h3 id=настройка-xray-сервера>Настройка Xray сервера<a hidden class=anchor aria-hidden=true href=#настройка-xray-сервера>#</a></h3><p>Скачиваем и распаковываем бинарник для Linux:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget -c https://github.com/XTLS/Xray-core/releases/download/v1.8.3/Xray-linux-64.zip
</span></span><span class=line><span class=cl>unzip Xray-linux-64.zip -d  /opt/xray
</span></span></code></pre></div><blockquote><p>Последние релизы см тут <a href=https://github.com/XTLS/Xray-core/releases/>https://github.com/XTLS/Xray-core/releases/</a></p></blockquote><p>Создаем <code>/etc/systemd/system/xray.service</code>:</p><pre tabindex=0><code>[Unit]
Description=Xray Service
Documentation=https://github.com/xtls
After=network.target nss-lookup.target

[Service]
User=nobody
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true
ExecStart=/opt/xray/xray run -config /opt/xray/config.json
Restart=on-failure
RestartPreventExitStatus=23
LimitNPROC=10000
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
</code></pre><p>Включаем сервис:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>systemctl <span class=nb>enable</span> xray
</span></span></code></pre></div><p>Создаем ключи</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># ID клиента</span>
</span></span><span class=line><span class=cl>/opt/xray/xray uuid
</span></span><span class=line><span class=cl>UUID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># приватный и публичные ключи сервера</span>
</span></span><span class=line><span class=cl>/opt/xray/xray x25519
</span></span><span class=line><span class=cl>Private key: YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY
</span></span><span class=line><span class=cl>Public key: ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># short ID</span>
</span></span><span class=line><span class=cl>openssl rand -hex <span class=m>8</span>
</span></span><span class=line><span class=cl>aaaaaaabbbbbbb
</span></span></code></pre></div><p><code>/opt/xray/config.json</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;loglevel&#34;</span><span class=p>:</span> <span class=s2>&#34;warning&#34;</span> <span class=c1>// info для отладки
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;routing&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;rules&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;domainStrategy&#34;</span><span class=p>:</span> <span class=s2>&#34;AsIs&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;inbounds&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;listen&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>8443</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;protocol&#34;</span><span class=p>:</span> <span class=s2>&#34;vless&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;tag&#34;</span><span class=p>:</span> <span class=s2>&#34;vless_tls&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;settings&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;clients&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#34;</span><span class=p>,</span> <span class=c1>// ID клиента
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nt>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;user1@myserver&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;flow&#34;</span><span class=p>:</span> <span class=s2>&#34;xtls-rprx-vision&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;decryption&#34;</span><span class=p>:</span> <span class=s2>&#34;none&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;streamSettings&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;network&#34;</span><span class=p>:</span> <span class=s2>&#34;tcp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;security&#34;</span><span class=p>:</span> <span class=s2>&#34;reality&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;realitySettings&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;show&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;dest&#34;</span><span class=p>:</span> <span class=s2>&#34;www.google.com:443&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;xver&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;serverNames&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;www.google.com&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;privateKey&#34;</span><span class=p>:</span> <span class=s2>&#34;YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY&#34;</span><span class=p>,</span> <span class=c1>// приватный ключ сервер
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nt>&#34;minClientVer&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;maxClientVer&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;maxTimeDiff&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;shortIds&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;aaaaaaabbbbbbb&#34;</span><span class=p>]</span> <span class=c1>// short ID
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;sniffing&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;enabled&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;destOverride&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;http&#34;</span><span class=p>,</span> <span class=s2>&#34;tls&#34;</span><span class=p>,</span> <span class=s2>&#34;quic&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;outbounds&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;protocol&#34;</span><span class=p>:</span> <span class=s2>&#34;freedom&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;tag&#34;</span><span class=p>:</span> <span class=s2>&#34;direct&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;protocol&#34;</span><span class=p>:</span> <span class=s2>&#34;blackhole&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;tag&#34;</span><span class=p>:</span> <span class=s2>&#34;block&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>systemctl start xray
</span></span></code></pre></div><h3 id=настройка-xray-клиента>Настройка XRay клиента<a hidden class=anchor aria-hidden=true href=#настройка-xray-клиента>#</a></h3><p>Так же скачиваем и распаковываем клиент.
Настраиваем config.json:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;log&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;loglevel&#34;</span><span class=p>:</span> <span class=s2>&#34;warning&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;inbounds&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;listen&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=s2>&#34;1080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;protocol&#34;</span><span class=p>:</span> <span class=s2>&#34;socks&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;sniffing&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;enabled&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;destOverride&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;http&#34;</span><span class=p>,</span> <span class=s2>&#34;tls&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;routeOnly&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;settings&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;auth&#34;</span><span class=p>:</span> <span class=s2>&#34;noauth&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;udp&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;listen&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=s2>&#34;1081&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;protocol&#34;</span><span class=p>:</span> <span class=s2>&#34;http&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;outbounds&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;protocol&#34;</span><span class=p>:</span> <span class=s2>&#34;vless&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;settings&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;vnext&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;123.44.55.67&#34;</span><span class=p>,</span> <span class=c1>//адрес сервера
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nt>&#34;port&#34;</span><span class=p>:</span> <span class=mi>443</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;users&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>              <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;user1@myserver&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;flow&#34;</span><span class=p>:</span> <span class=s2>&#34;xtls-rprx-vision&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;encryption&#34;</span><span class=p>:</span> <span class=s2>&#34;none&#34;</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;streamSettings&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;network&#34;</span><span class=p>:</span> <span class=s2>&#34;tcp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;security&#34;</span><span class=p>:</span> <span class=s2>&#34;reality&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;realitySettings&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;serverName&#34;</span><span class=p>:</span> <span class=s2>&#34;www.google.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;publicKey&#34;</span><span class=p>:</span> <span class=s2>&#34;ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;shortId&#34;</span><span class=p>:</span> <span class=s2>&#34;aaaaaaabbbbbbb&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;fingerprint&#34;</span><span class=p>:</span> <span class=s2>&#34;chrome&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;tag&#34;</span><span class=p>:</span> <span class=s2>&#34;proxy&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;protocol&#34;</span><span class=p>:</span> <span class=s2>&#34;freedom&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;tag&#34;</span><span class=p>:</span> <span class=s2>&#34;direct&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;routing&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;domainStrategy&#34;</span><span class=p>:</span> <span class=s2>&#34;AsIs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;rules&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;field&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;ip&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;geoip:private&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;outboundTag&#34;</span><span class=p>:</span> <span class=s2>&#34;direct&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./xray run -c ./config.json
</span></span></code></pre></div><p>После запуска xray на клиенте будет доступен socks прокси на порту <code>1080</code> и http на <code>1081</code>.</p><p>Для проверки на локальной машине можете добавить в <code>/etc/hosts</code>:</p><pre tabindex=0><code class=language-hosts data-lang=hosts>123.44.55.67 www.google.com
</code></pre><p>Если все ОК и попытаться открыть <a href=https://www.google.com>www.google.com</a> в браузере - вы должны через xray получить рабочий сайт google. Это то, что так же должен увидеть человек, который делает active probing вашего хоста.</p><h3 id=ссылки-для-автоматической-настройки-клиентов>Ссылки для автоматической настройки клиентов<a hidden class=anchor aria-hidden=true href=#ссылки-для-автоматической-настройки-клиентов>#</a></h3><p>Для быстрой настойки например мобильных клиентов можно подговорить ссылку со всеми параметрами подключения и импортировать её в клиенте.</p><p>Ссылка должна быть вида vless://<code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code>@<code>123.44.55.67:443</code>?security=reality&amp;encryption=none&amp;pbk=<code>ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ</code>&amp;headerType=none&amp;fp=<code>chrome</code>&amp;type=tcp&amp;flow=xtls-rprx-vision&amp;sni=<code>www.google.com</code>&amp;sid=<code>aaaaaaabbbbbbb</code>#vless</p><p>Ссылку можно конвертировать в QR и передавать другим пользователям.</p><h3 id=upd-дополнение-от-ysery>[UPD] Дополнение от <a href=https://github.com/Ysery>@Ysery</a><a hidden class=anchor aria-hidden=true href=#upd-дополнение-от-ysery>#</a></h3><p>Возникла проблема — в логах при обращении к сайту(ам) IP адреса посетителей определяются как <code>127.0.0.1</code>.</p><p>Нашёл решение, используя <code>proxy_protocol</code>. Вот как это выглядит в конфиге:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>...</span>
</span></span><span class=line><span class=cl><span class=s>upstream</span> <span class=s>xray</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>server</span> <span class=n>127.0.0.1</span><span class=p>:</span><span class=mi>8050</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>upstream</span> <span class=s>www</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>server</span> <span class=n>127.0.0.1</span><span class=p>:</span><span class=mi>7443</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span>          <span class=mi>443</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span>      <span class=nv>$sni_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_protocol</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_preread</span>     <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>8050</span> <span class=s>proxy_protocol</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span> <span class=n>127.0.0.1</span><span class=p>:</span><span class=mi>8443</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Не забудьте также в блоке слушателей сайта указать</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>    <span class=k>listen</span> <span class=mi>7443</span> <span class=s>ssl</span> <span class=s>proxy_protocol</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>listen</span> <span class=s>[::]:7443</span> <span class=s>ssl</span> <span class=s>proxy_protocol</span><span class=p>;</span>
</span></span></code></pre></div><p>И в блоке http вот это надо прописать.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>http</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1># Включаем поддержку реального IP
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>set_real_ip_from</span> <span class=n>127.0.0.1</span><span class=p>;</span>   <span class=c1>#Доверяем локальному прокси
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>real_ip_header</span> <span class=s>proxy_protocol</span><span class=p>;</span>   <span class=c1>#Используем заголовок для получения реального IP клиента (чтобы в логах именно он и прописывался)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>...</span>
</span></span></code></pre></div><p>Принцип прост: в просушиваемый на 443 порту TCP трафик добавляется заголовок с IP адресом при передаче слушателю на сервере. А чтобы отключить такое поведение для трафика, что передаётся на xray, он проходит через ещё один сервер, где заголовки эти удаляются.<br>Уточню на всякий случай, что указывать надо поддержку <code>proxy_protocol</code> только для соответствующего слушающего порта (блок слушателей сайта). Для остальных это делать не надо, включая quic, который работает на 443 порту, но по UDP и, соответственно, никак не мешает слушателю в блоке stream, который оперирует только TCP.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://coyotle.ru/tags/linux/>Linux</a></li><li><a href=https://coyotle.ru/tags/network/>Network</a></li><li><a href=https://coyotle.ru/tags/vpn/>Vpn</a></li></ul><nav class=paginav><a class=prev href=https://coyotle.ru/posts/cyberpunk-2023/><span class=title>« Предыдущая</span><br><span>Cyberpunk 2023</span>
</a><a class=next href=https://coyotle.ru/posts/chatgpt-at-home/><span class=title>Следующая »</span><br><span>У нас есть ChatGPT дома</span></a></nav></footer><div class=comments></div><script>function setComments(e){let t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("id","comments-script"),t.setAttribute("repo","coyotle/blog"),t.setAttribute("issue-term","pathname"),t.setAttribute("theme",e),t.setAttribute("label","comment"),t.setAttribute("crossorigin","anonymous"),t.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(t)}document.getElementById("theme-toggle").addEventListener("click",()=>{setComments(document.body.className.includes("dark")?"github-light":"github-dark")});let theme=document.body.className.includes("dark")?"github-dark":"github-light";setComments(theme)</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://coyotle.ru/>Мини-блог об IT, Linux, Open Source, Tech</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="копировать";function s(){t.innerHTML="скопировано!",setTimeout(()=>{t.innerHTML="копировать"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>