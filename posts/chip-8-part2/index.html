<!doctype html><html lang=ru dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Эмулируем CHIP-8 на Rust. Часть 2 | Мини-блог об IT, Linux, Open Source, Tech</title><meta name=keywords content="rust,chip-8"><meta name=description content="Это продолжение предыдущего поста, где я начал писать эмулятор CHIP-8 на Rust и вот, в неравной борьбе со своей невнимательностью и опечатками, я его доделал до рабочего состояния.
Никогда раньше (со времен универа) не занимался ничем низкоуровневым, где понадобились бы битовые сдвиги, маски и вот это всё, но по факту это просто.
В предыдущей заметке показал как разбирать код ROM-ов на опкоды и интерпретировать их. Далее просто необходимо внимательно реализовать все 35 команд CHIP-8."><meta name=author content><link rel=canonical href=https://coyotle.ru/posts/chip-8-part2/><link crossorigin=anonymous href=/assets/css/stylesheet.d6626ca70f3a7dda16dfce9eb29df152c81185d6739a741054093fb92b9e6839.css integrity="sha256-1mJspw86fdoW386esp3xUsgRhdZzmnQQVAk/uSueaDk=" rel="preload stylesheet" as=style><link rel=icon href=https://coyotle.ru/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://coyotle.ru/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://coyotle.ru/favicon-32x32.png><link rel=apple-touch-icon href=https://coyotle.ru/apple-touch-icon.png><link rel=mask-icon href=https://coyotle.ru/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ru href=https://coyotle.ru/posts/chip-8-part2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://coyotle.ru/posts/chip-8-part2/"><meta property="og:site_name" content="Мини-блог об IT, Linux, Open Source, Tech"><meta property="og:title" content="Эмулируем CHIP-8 на Rust. Часть 2"><meta property="og:description" content="Это продолжение предыдущего поста, где я начал писать эмулятор CHIP-8 на Rust и вот, в неравной борьбе со своей невнимательностью и опечатками, я его доделал до рабочего состояния.
Никогда раньше (со времен универа) не занимался ничем низкоуровневым, где понадобились бы битовые сдвиги, маски и вот это всё, но по факту это просто.
В предыдущей заметке показал как разбирать код ROM-ов на опкоды и интерпретировать их. Далее просто необходимо внимательно реализовать все 35 команд CHIP-8."><meta property="og:locale" content="ru-RU"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-15T18:40:03+03:00"><meta property="article:modified_time" content="2025-02-15T18:40:03+03:00"><meta property="article:tag" content="Rust"><meta property="article:tag" content="Chip-8"><meta property="og:image" content="https://coyotle.ru/cover.jpeg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://coyotle.ru/cover.jpeg"><meta name=twitter:title content="Эмулируем CHIP-8 на Rust. Часть 2"><meta name=twitter:description content="Это продолжение предыдущего поста, где я начал писать эмулятор CHIP-8 на Rust и вот, в неравной борьбе со своей невнимательностью и опечатками, я его доделал до рабочего состояния.
Никогда раньше (со времен универа) не занимался ничем низкоуровневым, где понадобились бы битовые сдвиги, маски и вот это всё, но по факту это просто.
В предыдущей заметке показал как разбирать код ROM-ов на опкоды и интерпретировать их. Далее просто необходимо внимательно реализовать все 35 команд CHIP-8."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Посты","item":"https://coyotle.ru/posts/"},{"@type":"ListItem","position":2,"name":"Эмулируем CHIP-8 на Rust. Часть 2","item":"https://coyotle.ru/posts/chip-8-part2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Эмулируем CHIP-8 на Rust. Часть 2","name":"Эмулируем CHIP-8 на Rust. Часть 2","description":"Это продолжение предыдущего поста, где я начал писать эмулятор CHIP-8 на Rust и вот, в неравной борьбе со своей невнимательностью и опечатками, я его доделал до рабочего состояния.\nНикогда раньше (со времен универа) не занимался ничем низкоуровневым, где понадобились бы битовые сдвиги, маски и вот это всё, но по факту это просто.\nВ предыдущей заметке показал как разбирать код ROM-ов на опкоды и интерпретировать их. Далее просто необходимо внимательно реализовать все 35 команд CHIP-8.\n","keywords":["rust","chip-8"],"articleBody":"Это продолжение предыдущего поста, где я начал писать эмулятор CHIP-8 на Rust и вот, в неравной борьбе со своей невнимательностью и опечатками, я его доделал до рабочего состояния.\nНикогда раньше (со времен универа) не занимался ничем низкоуровневым, где понадобились бы битовые сдвиги, маски и вот это всё, но по факту это просто.\nВ предыдущей заметке показал как разбирать код ROM-ов на опкоды и интерпретировать их. Далее просто необходимо внимательно реализовать все 35 команд CHIP-8.\nИтоговый код получился такой:\nuse std::{path::PathBuf, usize}; pub struct Chip8 { pub memory: [u8; 4096], pub registers: [u8; 16], pub i_register: u16, pub pc: u16, pub delay_timer: u8, pub sound_timer: u8, pub stack: Vec\u003cu16\u003e, pub display: [[u8; 64]; 32], pub keys: [bool; 16], pub waiting_key_opcode: u16, } impl Default for Chip8 { fn default() -\u003e Self { Self { memory: [0; 4096], registers: [0; 16], i_register: 0, pc: 0x200, delay_timer: 0, sound_timer: 0, stack: Vec::new(), display: [[0; 64]; 32], keys: [false; 16], waiting_key_opcode: 0, } } } impl Chip8 { // очищаем память и всё остальное pub fn reset(\u0026mut self) { self.memory.fill(0); self.restart(); } // очищаем всё кроме памяти pub fn restart(\u0026mut self) { self.registers.fill(0); self.i_register = 0; self.pc = 0x200; self.stack.clear(); self.display.fill([0; 64]); self.keys.fill(false); self.delay_timer = 0; self.sound_timer = 0; self.waiting_key_opcode = 0; } fn load_rom(\u0026mut self, rom: \u0026[u8], start_address: usize) { self.reset(); let end_address = start_address + rom.len(); if end_address \u003e self.memory.len() { panic!(\"ROM is too large to fit in memory\"); } for (i, \u0026byte) in rom.iter().enumerate() { self.memory[start_address + i] = byte; } } pub fn load_from_file(\u0026mut self, filename: \u0026PathBuf) { let buffer = std::fs::read(\u0026filename).unwrap(); self.load_rom(\u0026buffer, 0x200); } pub fn get_current_opcode(\u0026self) -\u003e u16 { let byte1 = self.memory[self.pc as usize] as u16; let byte2 = self.memory[(self.pc + 1) as usize] as u16; (byte1 \u003c\u003c 8) | byte2 } // получаем текущий opcode и сдвигаем указатель pc на 2 fn get_opcode(\u0026mut self) -\u003e u16 { if self.pc as usize + 1 \u003e= self.memory.len() { panic!(\"Attempted to read opcode outside of memory bounds\"); } // ждем нажатия клавиши если нужно if self.waiting_key_opcode \u003e 0 { return self.waiting_key_opcode; } let byte1 = self.memory[self.pc as usize] as u16; let byte2 = self.memory[(self.pc + 1) as usize] as u16; self.pc += 2; (byte1 \u003c\u003c 8) | byte2 } // уменьшаем таймеры pub fn update_timers(\u0026mut self) { if self.delay_timer \u003e 0 { self.delay_timer -= 1; } if self.sound_timer \u003e 0 { self.sound_timer -= 1; } } pub fn execute_opcode(\u0026mut self) { let opcode = self.get_opcode(); match opcode \u0026 0xF000 { 0x0000 =\u003e self.handle_0xxx(opcode), 0x1000 =\u003e self.handle_1xxx(opcode), 0x2000 =\u003e self.handle_2xxx(opcode), 0x3000 =\u003e self.handle_3xxx(opcode), 0x4000 =\u003e self.handle_4xxx(opcode), 0x5000 =\u003e self.handle_5xxx(opcode), 0x6000 =\u003e self.handle_6xxx(opcode), 0x7000 =\u003e self.handle_7xxx(opcode), 0x8000 =\u003e self.handle_8xxx(opcode), 0x9000 =\u003e self.handle_9xxx(opcode), 0xA000 =\u003e self.handle_Axxx(opcode), 0xB000 =\u003e self.handle_Bxxx(opcode), 0xC000 =\u003e self.handle_Cxxx(opcode), 0xD000 =\u003e self.handle_Dxxx(opcode), 0xE000 =\u003e self.handle_Exxx(opcode), 0xF000 =\u003e self.handle_Fxxx(opcode), _ =\u003e panic!(\"Unknown opcode: {:#X}\", opcode), } } fn handle_0xxx(\u0026mut self, opcode: u16) { match opcode { 0x00E0 =\u003e self.display.fill([0; 64]), // CLS 0x00EE =\u003e self.pc = self.stack.pop().expect(\"Stack underflow\"), // RET _ =\u003e panic!(\"Unknown opcode: {:#X}\", opcode), } } fn handle_1xxx(\u0026mut self, opcode: u16) { self.pc = opcode \u0026 0x0FFF; // JMP } fn handle_2xxx(\u0026mut self, opcode: u16) { self.stack.push(self.pc); self.pc = opcode \u0026 0x0FFF; } fn handle_3xxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0x0F00) \u003e\u003e 8) as usize; let nn = (opcode \u0026 0x00FF) as u8; if self.registers[x] == nn { self.pc += 2; } } fn handle_4xxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0x0F00) \u003e\u003e 8) as usize; let nn = (opcode \u0026 0x00FF) as u8; if self.registers[x] != nn { self.pc += 2; } } fn handle_5xxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0x0F00) \u003e\u003e 8) as usize; let y = ((opcode \u0026 0x00F0) \u003e\u003e 4) as usize; if self.registers[x] == self.registers[y] { self.pc += 2; } } fn handle_6xxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0x0F00) \u003e\u003e 8) as usize; let nn = (opcode \u0026 0x00FF) as u8; self.registers[x] = nn; } fn handle_7xxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0x0F00) \u003e\u003e 8) as usize; let nn = (opcode \u0026 0x00FF) as u8; self.registers[x] = self.registers[x].wrapping_add(nn); } fn handle_8xxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0x0F00) \u003e\u003e 8) as usize; let y = ((opcode \u0026 0x00F0) \u003e\u003e 4) as usize; let vx = self.registers[x]; let vy = self.registers[y]; match opcode \u0026 0xF00F { 0x8000 =\u003e { // LD self.registers[x] = vy; } 0x8001 =\u003e { // OR self.registers[x] |= vy; } 0x8002 =\u003e { // AND self.registers[x] \u0026= vy; } 0x8003 =\u003e { // XOR self.registers[x] ^= vy; } 0x8004 =\u003e { // ADD let (res, carry) = vx.overflowing_add(vy); self.registers[x] = res; self.registers[0xF] = if carry { 1 } else { 0 }; } 0x8005 =\u003e { self.registers[0xF] = if vx \u003e vy { 1 } else { 0 }; self.registers[x] = vx.wrapping_sub(vy); } 0x8006 =\u003e { self.registers[0xF] = vx \u0026 0x01; self.registers[x] = vx \u003e\u003e 1; } 0x8007 =\u003e { let (res, carry) = vy.overflowing_sub(vx); self.registers[0xF] = if carry { 0 } else { 1 }; self.registers[x] = res; } 0x800E =\u003e { self.registers[0xF] = (vx \u003e\u003e 7) \u0026 1; self.registers[x] = vx \u003c\u003c 1; } _ =\u003e panic!(\"Unknown opcode: {:#X}\", opcode), } } fn handle_9xxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0xF00) \u003e\u003e 8) as usize; let y = ((opcode \u0026 0x0F0) \u003e\u003e 4) as usize; if self.registers[x] != self.registers[y] { self.pc += 2; } } fn handle_Axxx(\u0026mut self, opcode: u16) { self.i_register = opcode \u0026 0xFFF; } fn handle_Bxxx(\u0026mut self, opcode: u16) { self.pc = self.registers[0] as u16 + (opcode \u0026 0xFFF); } fn handle_Cxxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0xF00) \u003e\u003e 8) as usize; let nn = (opcode \u0026 0x0FF) as u8; self.registers[x] = rand::random::\u003cu8\u003e() \u0026 nn; } fn handle_Dxxx(\u0026mut self, opcode: u16) { let vx = self.registers[((opcode \u0026 0xF00) \u003e\u003e 8) as usize]; let vy = self.registers[((opcode \u0026 0x0F0) \u003e\u003e 4) as usize]; let n = opcode \u0026 0x000F; let x = (vx as usize) % 64; let y = (vy as usize) % 32; let sprite_data = \u0026self.memory[self.i_register as usize..self.i_register as usize + n as usize]; self.registers[0xF] = 0; for row in 0..n { for col in 0..8 { let pixel = (sprite_data[row as usize] \u003e\u003e (7 - col)) \u0026 1; let disp_x = (x + col as usize) % 64; let disp_y = (y + row as usize) % 32; let cur_pixel = self.display[disp_y][disp_x]; if cur_pixel \u003e 0 \u0026\u0026 pixel \u003e 0 { self.registers[0xF] = 1; } self.display[disp_y][disp_x] = cur_pixel ^ pixel; } } } fn handle_Exxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0xF00) \u003e\u003e 8) as usize; let vx = self.registers[x] as usize; //key index match opcode \u0026 0xF0FF { 0xE09E =\u003e { if self.keys[vx] { self.pc += 2; } } 0xE0A1 =\u003e { if !self.keys[vx] { self.pc += 2; } } _ =\u003e panic!(\"Unknown opcode: {:#X}\", opcode), } } fn handle_Fxxx(\u0026mut self, opcode: u16) { let x = ((opcode \u0026 0xF00) \u003e\u003e 8) as usize; let vx = self.registers[x]; match opcode \u0026 0xF0FF { 0xF007 =\u003e { self.registers[x] = self.delay_timer; } 0xF00A =\u003e { self.waiting_key_opcode = opcode; for (i, \u0026key) in self.keys.iter().enumerate() { if key { self.waiting_key_opcode = 0; self.registers[x] = i as u8; break; } } } 0xF015 =\u003e { self.delay_timer = self.registers[x]; } 0xF018 =\u003e { self.sound_timer = self.registers[x]; } 0xF01E =\u003e { self.i_register += self.registers[x] as u16; } 0xF029 =\u003e { self.i_register = self.registers[x] as u16 * 0x05; } 0xF033 =\u003e { self.memory[self.i_register as usize] = vx / 100; self.memory[self.i_register as usize + 1] = (vx / 10) % 10; self.memory[self.i_register as usize + 2] = vx % 10; } 0xF055 =\u003e { for i in 0..=x { self.memory[self.i_register as usize + i] = self.registers[i]; } } 0xF065 =\u003e { for i in 0..=x { self.registers[i] = self.memory[self.i_register as usize + i]; } } _ =\u003e panic!(\"Unknown opcode: {:#X}\", opcode), } } } Как теперь это запустить? После того как реализация эмулятора готова, можно визуализировать состояние дисплея и организовать обновление состояния эмулятора. Я выбрал Bevy для рендеринга и обработки нажатий кнопок. В итоге получилось что-то такое:\nmod chip8; use bevy::prelude::*; use chip8::Chip8; use clap::Parser; use std::path::PathBuf; #[derive(Parser, Debug)] #[command(author, version, about, long_about = None)] struct Args { /// Path to the ROM file #[arg(short, long)] rom: PathBuf, } fn main() { let args = Args::parse(); println!(\"Loading ROM: {:?}\", args.rom); let mut chip8 = Chip8::default(); chip8.load_from_file(\u0026args.rom); App::new() .add_plugins(DefaultPlugins) .insert_resource(chip8) .add_systems(Startup, setup) .add_systems(Startup, setup_display) .add_systems(Update, (update_keys, draw_display)) .add_systems(FixedUpdate, (run_chip8, update_chip8_timers)) .add_systems(FixedUpdate, draw_registers) .run(); } #[derive(Component)] struct PcText; fn setup(mut commands: Commands) { commands.spawn(Camera2d::default()); commands.spawn(( Text::new(\"PC: 0x0000\\nOP: 0x0000\"), TextFont { font_size: 16.0, ..default() }, PcText, )); } const DISPLAY_WIDTH: usize = 64; const DISPLAY_HEIGHT: usize = 32; const PIXEL_SIZE: f32 = 10.0; const COLOR_ON: Color = Color::srgb(0.0, 1.0, 0.0); const COLOR_OFF: Color = Color::srgb(0.0, 0.0, 0.0); #[derive(Component)] struct Chip8Pixel { x: usize, y: usize, } // Создаем \"пиксели\" для отображения состояния дисплея CHIP-8 fn setup_display(mut commands: Commands) { for y in 0..DISPLAY_HEIGHT { for x in 0..DISPLAY_WIDTH { commands.spawn(( Sprite::from_color(COLOR_OFF, Vec2::new(PIXEL_SIZE, PIXEL_SIZE)), Transform::from_xyz( x as f32 * PIXEL_SIZE - DISPLAY_WIDTH as f32 * PIXEL_SIZE / 2.0, DISPLAY_HEIGHT as f32 * PIXEL_SIZE / 2.0 - y as f32 * PIXEL_SIZE, 0.0, ), Chip8Pixel { x, y }, )); } } } /// Обновляем состояние CHIP-8 с частотой 500Hz fn run_chip8(mut chip8: ResMut\u003cChip8\u003e, time: Res\u003cTime\u003e, mut accumulator: Local\u003cf32\u003e) { *accumulator += time.delta_secs(); let cycle_time = 1.0 / 500.0; while *accumulator \u003e= cycle_time { chip8.execute_opcode(); *accumulator -= cycle_time; } } /// Обновляем таймеры CHIP-8 с частотой 60Hz fn update_chip8_timers(mut chip8: ResMut\u003cChip8\u003e, time: Res\u003cTime\u003e, mut accumulator: Local\u003cf32\u003e) { *accumulator += time.delta_secs(); let timer_interval = 1.0 / 60.0; while *accumulator \u003e= timer_interval { chip8.update_timers(); *accumulator -= timer_interval; } } // Обрабатываем нажатия клавиш fn update_keys(keyboard_input: Res\u003cButtonInput\u003cKeyCode\u003e\u003e, mut chip8: ResMut\u003cChip8\u003e) { // Перезапускаем эмулятор при нажатии Escape if keyboard_input.pressed(KeyCode::Escape) { chip8.restart(); } let key_map = [ KeyCode::KeyX, KeyCode::Digit1, KeyCode::Digit2, KeyCode::Digit3, KeyCode::KeyQ, KeyCode::KeyW, KeyCode::KeyE, KeyCode::KeyA, KeyCode::KeyS, KeyCode::KeyD, KeyCode::KeyZ, KeyCode::KeyC, KeyCode::Digit4, KeyCode::KeyR, KeyCode::KeyF, KeyCode::KeyV, ]; for (i, \u0026key_code) in key_map.iter().enumerate() { chip8.keys[i] = keyboard_input.pressed(key_code); } } // Обновляем состояние пикселей fn draw_display(chip8: Res\u003cChip8\u003e, mut query: Query\u003c(\u0026Chip8Pixel, \u0026mut Sprite)\u003e) { for (px, mut sprite) in query.ite r_mut() { sprite.color = if chip8.display[px.y][px.x] \u003e 0 { COLOR_ON } else { COLOR_OFF }; } } // Обновляем регистр PC и текущий opcode fn draw_registers(chip8: Res\u003cChip8\u003e, mut text: Single\u003c\u0026mut Text, With\u003cPcText\u003e\u003e) { let pc = chip8.pc; let op = chip8.get_current_opcode(); text.0 = format!(\"PC: {:04X}\\nOP: {:04X}\", pc, op); } Компилируем, запускаем и видим такую красоту. Аж олдскулы свело!\nУправлять играми можно через клавиши: 1 2 3 4 Q W E R A S D F Z X C V и Esc для сброса состояния эмулятора.\nЕдинственное что я не делал - звук. В оригинале это просто бипер, который выдает одну ноту пока sound_timer \u003e 0.\nЕсли есть желание, можете доделать, патчи приветствуются. Код доступен на GitHub, там же лежат готовые сборки под Linux и Windows, ROMы можно скачать тут.\nКак еще можно улучшить эмулятор:\nДобавить меню с выбором ROMa Оформить окно в ретро стиле Сделать CRT шейдер Сделать overlay с состоянием регистров эмулятора UPD. Всё таки добавил звук. Сначала просто с помощью проигрывания готового OGG, потом переделал на генератор волны т.к. таскать с эмулятором единственный дополнительный ресурс - такое себе.\nUPD2. Добавил паузу эмулятора на P\nЧто делать дальше? После успешной разработки эмулятора CHIP-8 следующим шагом может быть создание эмулятора для более сложной системы:\nSuper CHIP-8: Это расширение оригинального CHIP-8, добавляет новые инструкции и увеличивает разрешение экрана. Логичный и простой шаг.\nCOSMAC VIP: Оригинальная платформа, для которой был разработан CHIP-8. Эмуляция COSMAC VIP предоставит опыт работы с реальной аппаратной архитектурой, включая эмуляцию процессора RCA 1802 и периферийных устройств.\nGame Boy: Портативка от Nintendo с 8-битной архитектурой. Потребуется понимание работы с более сложными процессорами, такими как Z80, а также работы с аудио- и видеоподсистемами.\nNES: Классическая 8-битная консоль, в СНГ продавались клоны под названием Dendy. Насколько знаю, может быть сложной т.к. имеет много недокументированных особенностей.\n","wordCount":"1981","inLanguage":"ru","image":"https://coyotle.ru/cover.jpeg","datePublished":"2025-02-15T18:40:03+03:00","dateModified":"2025-02-15T18:40:03+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://coyotle.ru/posts/chip-8-part2/"},"publisher":{"@type":"Organization","name":"Мини-блог об IT, Linux, Open Source, Tech","logo":{"@type":"ImageObject","url":"https://coyotle.ru/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://coyotle.ru/ accesskey=h title="Мини-блог об IT, Linux, Open Source, Tech (Alt + H)">Мини-блог об IT, Linux, Open Source, Tech</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://coyotle.ru/tags/ title=тэги><span>тэги</span></a></li><li><a href=https://coyotle.ru/about/ title="обо мне"><span>обо мне</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Эмулируем CHIP-8 на Rust. Часть 2</h1><div class=post-meta><span title='2025-02-15 18:40:03 +0300 +0300'>15 февраля 2025</span></div></header><figure class=entry-cover><img loading=eager srcset='https://coyotle.ru/posts/chip-8-part2/cover_hu_bcb89c6533e0c398.jpeg 360w,https://coyotle.ru/posts/chip-8-part2/cover_hu_cbda6806273dd5b3.jpeg 480w,https://coyotle.ru/posts/chip-8-part2/cover.jpeg 500w' src=https://coyotle.ru/posts/chip-8-part2/cover.jpeg sizes="(min-width: 768px) 720px, 100vw" width=500 height=300 alt="retro pc"></figure><div class=post-content><p>Это продолжение <a href=https://coyotle.ru/posts/chip-8-part1/>предыдущего поста</a>, где я начал писать эмулятор CHIP-8 на Rust и вот, в неравной борьбе со своей невнимательностью и опечатками, я его доделал до рабочего состояния.</p><p>Никогда раньше (со времен универа) не занимался ничем низкоуровневым, где понадобились бы битовые сдвиги, маски и вот это всё, но по факту это просто.</p><p>В предыдущей заметке показал как разбирать код ROM-ов на опкоды и интерпретировать их. Далее просто необходимо внимательно реализовать все 35 команд CHIP-8.</p><p>Итоговый код получился такой:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=p>{</span><span class=n>path</span>::<span class=n>PathBuf</span><span class=p>,</span><span class=w> </span><span class=kt>usize</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Chip8</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>memory</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>4096</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>registers</span>: <span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>16</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>i_register</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>pc</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>delay_timer</span>: <span class=kt>u8</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>sound_timer</span>: <span class=kt>u8</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>stack</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u16</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>display</span>: <span class=p>[[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>64</span><span class=p>];</span><span class=w> </span><span class=mi>32</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>keys</span>: <span class=p>[</span><span class=kt>bool</span><span class=p>;</span><span class=w> </span><span class=mi>16</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>waiting_key_opcode</span>: <span class=kt>u16</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=nb>Default</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Chip8</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>default</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>memory</span>: <span class=p>[</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=mi>4096</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>registers</span>: <span class=p>[</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=mi>16</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>i_register</span>: <span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pc</span>: <span class=mh>0x200</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>delay_timer</span>: <span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sound_timer</span>: <span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stack</span>: <span class=nb>Vec</span>::<span class=n>new</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>display</span>: <span class=p>[[</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=mi>64</span><span class=p>];</span><span class=w> </span><span class=mi>32</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>keys</span>: <span class=p>[</span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=mi>16</span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>waiting_key_opcode</span>: <span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Chip8</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// очищаем память и всё остальное
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>reset</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>.</span><span class=n>fill</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>restart</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// очищаем всё кроме памяти
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>restart</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>.</span><span class=n>fill</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x200</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>display</span><span class=p>.</span><span class=n>fill</span><span class=p>([</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=mi>64</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>keys</span><span class=p>.</span><span class=n>fill</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>delay_timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>sound_timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>waiting_key_opcode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>load_rom</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>rom</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>],</span><span class=w> </span><span class=n>start_address</span>: <span class=kt>usize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>reset</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>end_address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>start_address</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>rom</span><span class=p>.</span><span class=n>len</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>end_address</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;ROM is too large to fit in memory&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>byte</span><span class=p>)</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>rom</span><span class=p>.</span><span class=n>iter</span><span class=p>().</span><span class=n>enumerate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[</span><span class=n>start_address</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>byte</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>load_from_file</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>filename</span>: <span class=kp>&amp;</span><span class=nc>PathBuf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span>::<span class=n>fs</span>::<span class=n>read</span><span class=p>(</span><span class=o>&amp;</span><span class=n>filename</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>load_rom</span><span class=p>(</span><span class=o>&amp;</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=mh>0x200</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_current_opcode</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>u16</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>byte1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u16</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>byte2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[(</span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u16</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>byte1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>byte2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// получаем текущий opcode и сдвигаем указатель pc на 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>fn</span> <span class=nf>get_opcode</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>u16</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;Attempted to read opcode outside of memory bounds&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ждем нажатия клавиши если нужно
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>waiting_key_opcode</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>waiting_key_opcode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>byte1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u16</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>byte2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[(</span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u16</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>byte1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>byte2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// уменьшаем таймеры
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>update_timers</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>delay_timer</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>delay_timer</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>sound_timer</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>sound_timer</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>execute_opcode</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>get_opcode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF000</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x0000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_0xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x1000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_1xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x2000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_2xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x3000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_3xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x4000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_4xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x5000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_5xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x6000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_6xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x7000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_7xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x8000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_8xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x9000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_9xxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xA000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_Axxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xB000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_Bxxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xC000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_Cxxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xD000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_Dxxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xE000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_Exxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>handle_Fxxx</span><span class=p>(</span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;Unknown opcode: </span><span class=si>{:#X}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_0xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x00E0</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>display</span><span class=p>.</span><span class=n>fill</span><span class=p>([</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=mi>64</span><span class=p>]),</span><span class=w> </span><span class=c1>// CLS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=mh>0x00EE</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Stack underflow&#34;</span><span class=p>),</span><span class=w> </span><span class=c1>// RET
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;Unknown opcode: </span><span class=si>{:#X}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_1xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0FFF</span><span class=p>;</span><span class=w>  </span><span class=c1>// JMP
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_2xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0FFF</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_3xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0F00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>nn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x00FF</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>nn</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_4xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0F00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>nn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x00FF</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>nn</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_5xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0F00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x00F0</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>y</span><span class=p>]</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_6xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0F00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>nn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x00FF</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nn</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_7xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0F00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>nn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x00FF</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>wrapping_add</span><span class=p>(</span><span class=n>nn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_8xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0F00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x00F0</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>vy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>y</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF00F</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x8000</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// LD
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x8001</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// OR
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>vy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x8002</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// AND
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=n>vy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x8003</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// XOR
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>^=</span><span class=w> </span><span class=n>vy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x8004</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// ADD
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=p>,</span><span class=w> </span><span class=n>carry</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vx</span><span class=p>.</span><span class=n>overflowing_add</span><span class=p>(</span><span class=n>vy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=mh>0xF</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>carry</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x8005</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=mh>0xF</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>vy</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vx</span><span class=p>.</span><span class=n>wrapping_sub</span><span class=p>(</span><span class=n>vy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x8006</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=mh>0xF</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x01</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x8007</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=p>,</span><span class=w> </span><span class=n>carry</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vy</span><span class=p>.</span><span class=n>overflowing_sub</span><span class=p>(</span><span class=n>vx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=mh>0xF</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>carry</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0x800E</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=mh>0xF</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>vx</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>7</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;Unknown opcode: </span><span class=si>{:#X}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_9xxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0F0</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>y</span><span class=p>]</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_Axxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFFF</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_Bxxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u16</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFFF</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_Cxxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>nn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0FF</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rand</span>::<span class=n>random</span>::<span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>nn</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_Dxxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>vy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0F0</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x000F</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>vx</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>vy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>32</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>sprite_data</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=o>..</span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=mh>0xF</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=n>n</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=n>col</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=mi>8</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>pixel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>sprite_data</span><span class=p>[</span><span class=n>row</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>]</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>(</span><span class=mi>7</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>col</span><span class=p>))</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>disp_x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>col</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>disp_y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>32</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>cur_pixel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>display</span><span class=p>[</span><span class=n>disp_y</span><span class=p>][</span><span class=n>disp_x</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=n>cur_pixel</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>pixel</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=mh>0xF</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>display</span><span class=p>[</span><span class=n>disp_y</span><span class=p>][</span><span class=n>disp_x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cur_pixel</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>pixel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_Exxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w> </span><span class=c1>//key index
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF0FF</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xE09E</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>keys</span><span class=p>[</span><span class=n>vx</span><span class=p>]</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xE0A1</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=bp>self</span><span class=p>.</span><span class=n>keys</span><span class=p>[</span><span class=n>vx</span><span class=p>]</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;Unknown opcode: </span><span class=si>{:#X}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>handle_Fxxx</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF00</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xF0FF</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF007</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>delay_timer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF00A</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>waiting_key_opcode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>opcode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>keys</span><span class=p>.</span><span class=n>iter</span><span class=p>().</span><span class=n>enumerate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=bp>self</span><span class=p>.</span><span class=n>waiting_key_opcode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF015</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>delay_timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF018</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>sound_timer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF01E</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u16</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF029</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u16</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mh>0x05</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF033</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>vx</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vx</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF055</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..=</span><span class=n>x</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>i</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mh>0xF065</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..=</span><span class=n>x</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=bp>self</span><span class=p>.</span><span class=n>registers</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>memory</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>i_register</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>i</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;Unknown opcode: </span><span class=si>{:#X}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=как-теперь-это-запустить>Как теперь это запустить?<a hidden class=anchor aria-hidden=true href=#как-теперь-это-запустить>#</a></h2><p>После того как реализация эмулятора готова, можно визуализировать состояние дисплея и организовать обновление состояния эмулятора. Я выбрал Bevy для рендеринга и обработки нажатий кнопок. В итоге получилось что-то такое:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>mod</span> <span class=nn>chip8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>bevy</span>::<span class=n>prelude</span>::<span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>chip8</span>::<span class=n>Chip8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>clap</span>::<span class=n>Parser</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>path</span>::<span class=n>PathBuf</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Parser, Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[command(author, version, about, long_about = None)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Args</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Path to the ROM file
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=cp>#[arg(short, long)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>rom</span>: <span class=nc>PathBuf</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Args</span>::<span class=n>parse</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Loading ROM: </span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>rom</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>chip8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Chip8</span>::<span class=n>default</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>chip8</span><span class=p>.</span><span class=n>load_from_file</span><span class=p>(</span><span class=o>&amp;</span><span class=n>args</span><span class=p>.</span><span class=n>rom</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>add_plugins</span><span class=p>(</span><span class=n>DefaultPlugins</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>insert_resource</span><span class=p>(</span><span class=n>chip8</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>add_systems</span><span class=p>(</span><span class=n>Startup</span><span class=p>,</span><span class=w> </span><span class=n>setup</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>add_systems</span><span class=p>(</span><span class=n>Startup</span><span class=p>,</span><span class=w> </span><span class=n>setup_display</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>add_systems</span><span class=p>(</span><span class=n>Update</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>update_keys</span><span class=p>,</span><span class=w> </span><span class=n>draw_display</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>add_systems</span><span class=p>(</span><span class=n>FixedUpdate</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>run_chip8</span><span class=p>,</span><span class=w> </span><span class=n>update_chip8_timers</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>add_systems</span><span class=p>(</span><span class=n>FixedUpdate</span><span class=p>,</span><span class=w> </span><span class=n>draw_registers</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Component)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>PcText</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>setup</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=n>commands</span>: <span class=nc>Commands</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>commands</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=n>Camera2d</span>::<span class=n>default</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>commands</span><span class=p>.</span><span class=n>spawn</span><span class=p>((</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Text</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;PC: 0x0000</span><span class=se>\n</span><span class=s>OP: 0x0000&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TextFont</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>font_size</span>: <span class=mf>16.0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>..</span><span class=n>default</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PcText</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>DISPLAY_WIDTH</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>64</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>DISPLAY_HEIGHT</span>: <span class=kt>usize</span> <span class=o>=</span><span class=w> </span><span class=mi>32</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>PIXEL_SIZE</span>: <span class=kt>f32</span> <span class=o>=</span><span class=w> </span><span class=mf>10.0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>COLOR_ON</span>: <span class=nc>Color</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Color</span>::<span class=n>srgb</span><span class=p>(</span><span class=mf>0.0</span><span class=p>,</span><span class=w> </span><span class=mf>1.0</span><span class=p>,</span><span class=w> </span><span class=mf>0.0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>COLOR_OFF</span>: <span class=nc>Color</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Color</span>::<span class=n>srgb</span><span class=p>(</span><span class=mf>0.0</span><span class=p>,</span><span class=w> </span><span class=mf>0.0</span><span class=p>,</span><span class=w> </span><span class=mf>0.0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Component)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Chip8Pixel</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>x</span>: <span class=kt>usize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>y</span>: <span class=kt>usize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Создаем &#34;пиксели&#34; для отображения состояния дисплея CHIP-8
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fn</span> <span class=nf>setup_display</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=n>commands</span>: <span class=nc>Commands</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=no>DISPLAY_HEIGHT</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=no>DISPLAY_WIDTH</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>commands</span><span class=p>.</span><span class=n>spawn</span><span class=p>((</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Sprite</span>::<span class=n>from_color</span><span class=p>(</span><span class=no>COLOR_OFF</span><span class=p>,</span><span class=w> </span><span class=n>Vec2</span>::<span class=n>new</span><span class=p>(</span><span class=no>PIXEL_SIZE</span><span class=p>,</span><span class=w> </span><span class=no>PIXEL_SIZE</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Transform</span>::<span class=n>from_xyz</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>x</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f32</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=no>PIXEL_SIZE</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=no>DISPLAY_WIDTH</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f32</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=no>PIXEL_SIZE</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>2.0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=no>DISPLAY_HEIGHT</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f32</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=no>PIXEL_SIZE</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>2.0</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>f32</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=no>PIXEL_SIZE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=mf>0.0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Chip8Pixel</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Обновляем состояние CHIP-8 с частотой 500Hz
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>fn</span> <span class=nf>run_chip8</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=n>chip8</span>: <span class=nc>ResMut</span><span class=o>&lt;</span><span class=n>Chip8</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>time</span>: <span class=nc>Res</span><span class=o>&lt;</span><span class=n>Time</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>accumulator</span>: <span class=nc>Local</span><span class=o>&lt;</span><span class=kt>f32</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>*</span><span class=n>accumulator</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>time</span><span class=p>.</span><span class=n>delta_secs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>cycle_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>1.0</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>500.0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=o>*</span><span class=n>accumulator</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>cycle_time</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>chip8</span><span class=p>.</span><span class=n>execute_opcode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>*</span><span class=n>accumulator</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>cycle_time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Обновляем таймеры CHIP-8 с частотой 60Hz
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>fn</span> <span class=nf>update_chip8_timers</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=n>chip8</span>: <span class=nc>ResMut</span><span class=o>&lt;</span><span class=n>Chip8</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>time</span>: <span class=nc>Res</span><span class=o>&lt;</span><span class=n>Time</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>accumulator</span>: <span class=nc>Local</span><span class=o>&lt;</span><span class=kt>f32</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>*</span><span class=n>accumulator</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>time</span><span class=p>.</span><span class=n>delta_secs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>timer_interval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mf>1.0</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>60.0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=o>*</span><span class=n>accumulator</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>timer_interval</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>chip8</span><span class=p>.</span><span class=n>update_timers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>*</span><span class=n>accumulator</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>timer_interval</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Обрабатываем нажатия клавиш
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fn</span> <span class=nf>update_keys</span><span class=p>(</span><span class=n>keyboard_input</span>: <span class=nc>Res</span><span class=o>&lt;</span><span class=n>ButtonInput</span><span class=o>&lt;</span><span class=n>KeyCode</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>chip8</span>: <span class=nc>ResMut</span><span class=o>&lt;</span><span class=n>Chip8</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Перезапускаем эмулятор при нажатии Escape
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>keyboard_input</span><span class=p>.</span><span class=n>pressed</span><span class=p>(</span><span class=n>KeyCode</span>::<span class=n>Escape</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>chip8</span><span class=p>.</span><span class=n>restart</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>key_map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyX</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>Digit1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>Digit2</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>Digit3</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyQ</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyW</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyA</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyD</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyZ</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyC</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>Digit4</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyF</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KeyCode</span>::<span class=n>KeyV</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>key_code</span><span class=p>)</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>key_map</span><span class=p>.</span><span class=n>iter</span><span class=p>().</span><span class=n>enumerate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>chip8</span><span class=p>.</span><span class=n>keys</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>keyboard_input</span><span class=p>.</span><span class=n>pressed</span><span class=p>(</span><span class=n>key_code</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Обновляем состояние пикселей
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fn</span> <span class=nf>draw_display</span><span class=p>(</span><span class=n>chip8</span>: <span class=nc>Res</span><span class=o>&lt;</span><span class=n>Chip8</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>query</span>: <span class=nc>Query</span><span class=o>&lt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>Chip8Pixel</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>Sprite</span><span class=p>)</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>px</span><span class=p>,</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>sprite</span><span class=p>)</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>query</span><span class=p>.</span><span class=n>ite</span><span class=w>   </span><span class=n>r_mut</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sprite</span><span class=p>.</span><span class=n>color</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>chip8</span><span class=p>.</span><span class=n>display</span><span class=p>[</span><span class=n>px</span><span class=p>.</span><span class=n>y</span><span class=p>][</span><span class=n>px</span><span class=p>.</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>COLOR_ON</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>COLOR_OFF</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Обновляем регистр PC и текущий opcode
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fn</span> <span class=nf>draw_registers</span><span class=p>(</span><span class=n>chip8</span>: <span class=nc>Res</span><span class=o>&lt;</span><span class=n>Chip8</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>text</span>: <span class=nc>Single</span><span class=o>&lt;&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>Text</span><span class=p>,</span><span class=w> </span><span class=n>With</span><span class=o>&lt;</span><span class=n>PcText</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>chip8</span><span class=p>.</span><span class=n>pc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>op</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>chip8</span><span class=p>.</span><span class=n>get_current_opcode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>text</span><span class=p>.</span><span class=mi>0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;PC: </span><span class=si>{:04X}</span><span class=se>\n</span><span class=s>OP: </span><span class=si>{:04X}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pc</span><span class=p>,</span><span class=w> </span><span class=n>op</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Компилируем, запускаем и видим такую красоту. Аж олдскулы свело!</p><p><img loading=lazy src=/posts/chip-8-part2/game.webp></p><p>Управлять играми можно через клавиши: 1 2 3 4 Q W E R A S D F Z X C V и Esc для сброса состояния эмулятора.</p><p><del>Единственное что я не делал - звук.</del> В оригинале это просто бипер, который выдает одну ноту пока <code>sound_timer > 0</code>.</p><p>Если есть желание, можете доделать, патчи приветствуются. Код доступен на <a href=https://github.com/coyotle/chip8emu>GitHub</a>, там же лежат готовые сборки под Linux и Windows, ROMы можно скачать <a href=https://github.com/kripod/chip8-roms>тут</a>.</p><p>Как еще можно улучшить эмулятор:</p><ul><li>Добавить меню с выбором ROMa</li><li>Оформить окно в ретро стиле</li><li>Сделать CRT шейдер</li><li>Сделать overlay с состоянием регистров эмулятора</li></ul><p>UPD. Всё таки добавил звук. Сначала просто с помощью проигрывания готового OGG, потом переделал на генератор волны т.к. таскать с эмулятором единственный дополнительный ресурс - такое себе.</p><p>UPD2. Добавил паузу эмулятора на <code>P</code></p><h2 id=что-делать-дальше>Что делать дальше?<a hidden class=anchor aria-hidden=true href=#что-делать-дальше>#</a></h2><p>После успешной разработки эмулятора CHIP-8 следующим шагом может быть создание эмулятора для более сложной системы:</p><ol><li><p><strong>Super CHIP-8</strong>: Это расширение оригинального CHIP-8, добавляет новые инструкции и увеличивает разрешение экрана. Логичный и простой шаг.</p></li><li><p><strong>COSMAC VIP</strong>: Оригинальная платформа, для которой был разработан CHIP-8. Эмуляция COSMAC VIP предоставит опыт работы с реальной аппаратной архитектурой, включая эмуляцию процессора RCA 1802 и периферийных устройств.</p></li><li><p><strong>Game Boy</strong>: Портативка от Nintendo с 8-битной архитектурой. Потребуется понимание работы с более сложными процессорами, такими как Z80, а также работы с аудио- и видеоподсистемами.</p></li><li><p><strong>NES</strong>: Классическая 8-битная консоль, в СНГ продавались клоны под названием Dendy. Насколько знаю, может быть сложной т.к. имеет много недокументированных особенностей.</p></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://coyotle.ru/tags/rust/>Rust</a></li><li><a href=https://coyotle.ru/tags/chip-8/>Chip-8</a></li></ul><nav class=paginav><a class=prev href=https://coyotle.ru/posts/rust-hate-war/><span class=title>« Предыдущая</span><br><span>Rust и хейт-войны</span>
</a><a class=next href=https://coyotle.ru/posts/smotrim-rss-proxy/><span class=title>Следующая »</span><br><span>Проксируй меня полностью</span></a></nav></footer><div class=comments></div><script>function setComments(e){let t=document.createElement("script");t.src="https://utteranc.es/client.js",t.setAttribute("id","comments-script"),t.setAttribute("repo","coyotle/blog"),t.setAttribute("issue-term","pathname"),t.setAttribute("theme",e),t.setAttribute("label","comment"),t.setAttribute("crossorigin","anonymous"),t.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(t)}document.getElementById("theme-toggle").addEventListener("click",()=>{setComments(document.body.className.includes("dark")?"github-light":"github-dark")});let theme=document.body.className.includes("dark")?"github-dark":"github-light";setComments(theme)</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://coyotle.ru/>Мини-блог об IT, Linux, Open Source, Tech</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="копировать";function s(){t.innerHTML="скопировано!",setTimeout(()=>{t.innerHTML="копировать"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>